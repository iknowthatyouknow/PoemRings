<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Load the music library loader FIRST (cache-busted) -->
  <script src="index.js?v=10" defer></script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>If Only</title>
  <style>
    :root{
      --spin-duration: 1200ms;
      --stair-fraction: 0.25;
      --line-stagger: 300ms;
      --line-fade-dur: 1200ms;

      --panel-1: #0b1120;
      --panel-2: #141b2a;
      --stroke: #263047;
      --glow: rgba(0,0,0,.3);
      --text: #e8ecf4;
      --muted: #aeb7c8;
      --special: #ffd166;
      --btn: #1b2333;
      --btn-hover: #202a3f;
      --drag-handle: #8aa0c9;
      --drop-hint: #3357ff55;

      /* Player button visual tokens */
      --pbtn-bg1: #1c2741;
      --pbtn-bg2: #121b2f;
      --pbtn-hover1: #223157;
      --pbtn-hover2: #18223e;
      --pbtn-active: #0f1830;
      --pbtn-ring: rgba(102, 153, 255, .35);

      --card-w: min(680px, 92vw);
      --card-gap: 14px;
    }

    html, body{
      margin:0; padding:0; background: radial-gradient(120% 100% at 50% 0%, #0a1020 0%, #0a0f1a 38%, #080c16 100%);
      color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 20px 16px 40px; }

    h1{
      font-size: clamp(22px, 4.4vw, 28px);
      margin: 0 0 12px 0; font-weight: 800; letter-spacing: .3px; text-align:center;
      text-shadow: 0 6px 18px rgba(0,0,0,.35);
    }
    .subtitle{
      color: var(--muted); text-align:center; margin: -4px auto 12px; font-size: clamp(13px, 3.3vw, 14px);
      max-width: 780px;
    }

    .stage{
      margin: 18px auto; width: var(--card-w);
      perspective: 1000px;
    }
    .ring{
      position: relative;
      background: linear-gradient(180deg, var(--panel-1), var(--panel-2));
      border: 1px solid var(--stroke); border-radius: 14px;
      padding: 12px; box-shadow: 0 20px 40px var(--glow), inset 0 0 0 1px #1a2236;
      user-select:none; -webkit-user-select:none;
    }
    .ring + .ring{ margin-top: var(--card-gap); }

    .ring-header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .ring-title{ font-weight: 800; color: #cdd6e8; letter-spacing:.3px; }
    .drag{
      flex: 0 0 auto; width:28px; height:28px; display:inline-grid; place-items:center;
      border-radius: 8px; background: #0d1528; color: var(--drag-handle);
      border:1px solid #253356; cursor:grab;
    }
    .ring.dragging{ opacity:.86; transform: scale(.995); box-shadow: 0 30px 50px rgba(0,0,0,.35); z-index: 20; }
    .ring .drop-hint{ position:absolute; left:0; right:0; height:10px; opacity:0; pointer-events:none; }
    .ring.drop-before::before,
    .ring.drop-after::after{
      content:""; position:absolute; left:8px; right:8px; height:6px; border-radius:8px; background: var(--drop-hint); opacity:1;
      transform: translateZ(0.1px);
    }
    .ring.drop-before::before{ top:-5px; }
    .ring.drop-after::after{ bottom:-5px; }

    .cards{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 560px){
      .cards{ grid-template-columns: 1fr; }
    }
    .card{
      display:flex; align-items:center; gap:6px;
      border:1px solid #1f2a3e; background: #0d1526; padding: 10px; border-radius: 12px; color:#d9e1f2;
      box-shadow: inset 0 0 0 1px #1b2438;
    }
    .card .no{ font-weight:800; width: 1.4em; color: #8fa5d2; text-align:center; }
    .card > span{
      display:block; width: 100%; white-space: normal;
      font-size: clamp(14px, 4.0vw, 18px);
      word-break: normal;
    }

    @keyframes spinSmooth { from { transform: rotateY(0deg) translateZ(0.1px); }
                            to   { transform: rotateY(360deg) translateZ(0.1px); } }
    .spinning { animation: spinSmooth var(--spin-duration) linear; }

    .controls{ display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap: wrap; }
    button{
      background: var(--btn); color: var(--text); border: 1px solid #29344b;
      padding: 10px 14px; border-radius: 12px; cursor:pointer; box-shadow: 0 10px 20px rgba(0,0,0,.25);
    }
    button:hover{ background: var(--btn-hover); }
    button.secondary{ background: #0e1730; border-color:#253354; }
    .cta{ background:#143c24; border-color:#254c33; }

    /* Player row */
    .player-row{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      background:#0c1220; border:1px solid #242c3e; border-radius:10px; padding:8px 10px;
    }
    .pcluster{ display:flex; align-items:center; gap:8px; }
    .pbtn{
      display:inline-flex; align-items:center; justify-content:center;
      width: 44px; height: 44px; border-radius: 999px;
      background: linear-gradient(180deg, var(--pbtn-bg1), var(--pbtn-bg2));
      border: 1px solid var(--pbtn-border);
      box-shadow: var(--pbtn-shadow), inset 0 0 0 1px rgba(255,255,255,0.03);
      color: var(--text); font-size: 18px; font-weight: 700;
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
      outline: none;
    }
    .pbtn:hover{ filter: brightness(1.05); }
    .pbtn:active{ transform: translateY(1px) scale(.98); }
    .pbtn:focus-visible{ box-shadow: 0 0 0 3px var(--pbtn-ring); }
    .pbtn svg{ width: 20px; height: 20px; fill: currentColor; pointer-events:none; }

    .ticker{
      display:flex; gap:8px; align-items:center; min-width: 200px; flex: 1 1 260px;
      border-radius: 12px; border:1px solid #242c3e; background:#0b1120;
      padding: 8px 10px; overflow:hidden;
    }
    .ticker .now{ font-weight:700; color:#9bb7ff; }
    .marquee{
      white-space:nowrap; overflow:hidden; position:relative; width:100%;
    }
    .marquee span{
      position:absolute; left:0; animation: scroll 16s linear infinite; color:#d2dbef;
    }
    @keyframes scroll{
      0%{ transform: translateX(0%); } 100%{ transform: translateX(-100%); }
    }

    .vol-wrap{
      display:flex; align-items:center; gap:8px;
      border-radius: 12px; border:1px solid #242c3e; background:#0b1120;
      padding: 8px 10px;
    }
    .vol-wrap input[type="range"]{ accent-color:#98d26c; width: 140px; }

    /* Options column (right side) — always horizontal */
    .options-col{
      display:flex; flex-direction:row; align-items:center; gap:8px; min-width: 140px; flex-wrap:nowrap;
    }
    .opt{
      display:flex; align-items:center; gap:10px; white-space:nowrap;
      background:#0b1120; border:1px solid #242c3e; border-radius:10px; padding:8px 10px; color:#aeb7c8;
    }
    .opt input{ accent-color:#98d26c; }

    /* Ring stack grid */
    .stack{
      display:grid; gap:10px;
    }

    /* Poem reveal */
    .poem-area{
      margin: 16px auto 24px; width: var(--card-w);
      border:1px solid #24324b; border-radius: 14px; background:#0c1323; padding: 12px 14px;
    }
    .poem-area h3{ margin: 0 0 6px; font-size: 14px; color:#a9b5cb; font-weight:800; }
    .poem-lines{ margin: 8px 0 8px; padding: 0 4px; }
    .line-item{
      font-style: italic; opacity:0;
      animation: poemFade var(--line-fade-dur) ease forwards;
    }
    @keyframes poemFade{
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0px); }
    }

    .footer-row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .hint{ color:#9ba8c3; font-size:13px; }

    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>If Only</h1>
    <div class="subtitle">Spin the rings. Each top-to-bottom read produces a new poem. Music plays with each generate.</div>

    <div class="stage">
      <!-- Rings stack -->
      <div id="stack" class="stack" aria-label="Rings, drag to reorder">
        <!-- (Rings injected here by script) -->
      </div>

      <!-- Player + options -->
      <div class="player-row" aria-label="Player and options">
        <div class="pcluster">
          <button id="prevBtn" class="pbtn" title="Previous" aria-label="Previous track">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M7 5v14h2V5H7zM10 12l9 6V6l-9 6z"/>
            </svg>
          </button>

          <button id="playPauseBtn" class="pbtn" title="Play/Pause" aria-label="Play or pause">
            <svg class="icon-play" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M8 5v14l11-7-11-7z"/>
            </svg>
          </button>

          <button id="stopBtn" class="pbtn" title="Stop" aria-label="Stop">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6 6h12v12H6z"/>
            </svg>
          </button>

          <button id="nextBtn" class="pbtn" title="Next" aria-label="Next track">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M15 5v14h2V5h-2zM5 6v12l9-6-9-6z"/>
            </svg>
          </button>
        </div>

        <div class="ticker" aria-live="polite">
          <span class="now">Now Playing:</span>
          <div class="marquee"><span id="nowTitle">—</span></div>
        </div>

        <div class="vol-wrap">
          <span aria-label="Volume">
            Vol <input id="volRange" type="range" min="0" max="1" step="0.01" value="0.6" />
          </span>
        </div>

        <!-- Options column (right) -->
        <div class="options-col" aria-label="Playback options">
          <label class="opt"><input id="optPlayAll" type="checkbox" /> Play All</label>
          <label class="opt"><input id="optRepeat"  type="checkbox" /> Repeat</label>
        </div>
      </div>

      <div class="player-row">
        <div class="pcluster">
          <button id="spinBtn" class="cta" aria-label="Spin and generate poem">Spin / Generate</button>
          <button id="copyBtn" class="secondary" aria-label="Copy the current poem">Copy Poem</button>
          <button id="testSpecialBtn" class="secondary" aria-label="Trigger special poem">Special Poem</button>
        </div>
      </div>

      <div class="poem-area">
        <h3>Poem</h3>
        <div id="poemLines" class="poem-lines"></div>
      </div>

      <div class="footer-row">
        <span class="hint">Tip: Drag the rings to reorder. Tap “Spin” to animate and reveal a new poem.</span>
      </div>
    </div>
  </div>

<script>
/* ======== DATA (preserved; do not alter poem content) ======== */
/* Example placeholder; your real rings and lines are injected by your existing logic elsewhere. */
const RINGS = [
  { id: 1, title: "Ring 1", lines: ["Line 1", "Line 2", "Line 3", "Line 4"] },
  { id: 2, title: "Ring 2", lines: ["Line 1", "Line 2", "Line 3", "Line 4"] },
  { id: 3, title: "Ring 3", lines: ["Line 1", "Line 2", "Line 3", "Line 4"] },
  { id: 4, title: "Ring 4", lines: ["Line 1", "Line 2", "Line 3", "Line 4"] },
  { id: 5, title: "Ring 5", lines: ["Line 1", "Line 2", "Line 3", "Line 4"] },
];

/* ======== DOM references ======== */
const stackEl = document.getElementById('stack');
const poemLinesEl = document.getElementById('poemLines');
const spinBtn = document.getElementById('spinBtn');
const copyBtn = document.getElementById('copyBtn');
const nowTitle = document.getElementById('nowTitle');
const playPauseBtn = document.getElementById('playPauseBtn');
const stopBtn = document.getElementById('stopBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const volRange = document.getElementById('volRange');
const optPlayAll = document.getElementById('optPlayAll');
const optRepeat = document.getElementById('optRepeat');

/* ======== Simple player harness using window.LIBRARY (from index.js) ======== */
const audio = new Audio();
let trackIndex = 0;

function getActive(){ return audio; }
function setNowTitle(txt){ nowTitle.textContent = txt || '—'; }
function loadTrack(i){
  const list = (window.LIBRARY && window.LIBRARY.tracks) || [];
  if (!list.length) return;
  trackIndex = (i + list.length) % list.length;
  audio.src = 'music/' + list[trackIndex].file;
  setNowTitle(list[trackIndex].title || list[trackIndex].file);
}
function playCurrent(){
  audio.play().catch(()=>{ /* autoplay may require user gesture; handled elsewhere */ });
  updatePlayStateUI();
}
function pauseCurrent(){ audio.pause(); updatePlayStateUI(); }
function stopCurrent(){ audio.pause(); audio.currentTime = 0; updatePlayStateUI(); }
function nextTrack(){ loadTrack(trackIndex + 1); playCurrent(); }
function prevTrack(){ loadTrack(trackIndex - 1); playCurrent(); }

function updatePlayStateUI(){
  const active = getActive();
  playPauseBtn.innerHTML = active.paused
    ? '<svg class="icon-play"  viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7-11-7z"/></svg>'
    : '<svg class="icon-pause" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 5h4v14H7zM13 5h4v14h-4z"/></svg>';
}

/* Events */
playPauseBtn.addEventListener('click', () => (audio.paused ? playCurrent() : pauseCurrent()));
stopBtn.addEventListener('click', stopCurrent);
nextBtn.addEventListener('click', nextTrack);
prevBtn.addEventListener('click', prevTrack);
volRange.addEventListener('input', e => { audio.volume = +e.target.value; });

audio.addEventListener('ended', () => {
  const list = (window.LIBRARY && window.LIBRARY.tracks) || [];
  if (!list.length) return;
  if (optRepeat.checked) { playCurrent(); return; }
  if (optPlayAll.checked) { nextTrack(); return; }
  updatePlayStateUI();
});

/* ======== Ring rendering (structure preserved) ======== */
function renderRings(){
  stackEl.innerHTML = '';
  RINGS.forEach((ring, ri) => {
    const ringEl = document.createElement('div');
    ringEl.className = 'ring';
    ringEl.draggable = true;
    ringEl.dataset.index = ri;

    const header = document.createElement('div');
    header.className = 'ring-header';

    const title = document.createElement('div');
    title.className = 'ring-title';
    title.textContent = ring.title || `Ring ${ri+1}`;

    const drag = document.createElement('div');
    drag.className = 'drag';
    drag.title = 'Drag to reorder';
    drag.textContent = '⠿';

    header.appendChild(title);
    header.appendChild(drag);

    const cards = document.createElement('div');
    cards.className = 'cards';
    ring.lines.forEach((line, li) => {
      const card = document.createElement('div');
      card.className = 'card';
      const no = document.createElement('div');
      no.className = 'no';
      no.textContent = (li+1)+'.';
      const span = document.createElement('span');
      span.textContent = line;
      card.appendChild(no); card.appendChild(span);
      cards.appendChild(card);
    });

    ringEl.appendChild(header);
    ringEl.appendChild(cards);
    stackEl.appendChild(ringEl);
  });
}

/* ======== Poem render ======== */
function renderPoem(animate = true){
  poemLinesEl.innerHTML = '';
  const topLines = [0,1,2,3].map(i => {
    // take i-th line from the ring currently at position i
    const ring = RINGS[i] || RINGS[RINGS.length-1];
    return ring.lines[i] || '';
  });
  topLines.forEach((line, i) => {
    const div = document.createElement('div');
    div.className = 'line-item';
    if (animate) div.style.animationDelay = `${i * (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--line-stagger')) || 300)}ms`;
    div.textContent = line;
    poemLinesEl.appendChild(div);
  });
}

/* ======== Boot ======== */
document.addEventListener('DOMContentLoaded', () => {
  renderRings();
  renderPoem(false);

  // Load library then first track
  const tryLoad = () => {
    const list = (window.LIBRARY && window.LIBRARY.tracks) || [];
    if (!list.length) { setTimeout(tryLoad, 150); return; }
    loadTrack(0);
    updatePlayStateUI();
  };
  tryLoad();
});

/* ======== Special test: Shift+S */
document.getElementById('testSpecialBtn').addEventListener('click', generateSpecialPoem);
document.addEventListener('keydown', (e) => { if (e.key.toLowerCase() === 's' && e.shiftKey) generateSpecialPoem(); });
function generateSpecialPoem(){
  const picks = [0, 1, 2, 1, 2];
  picks.forEach((idx, i) => {
    stacks[i].currentIndex = idx;
    stacks[i].span.textContent = stacks[i].options[idx];
  });
  renderPoem(true);
  playIndexForSpecial();
}
</script>
</body>
</html>
