<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Poem Rings</title>

  <!-- Load the music library loader FIRST (cache-busted) -->
  <script src="index.js?v=6" defer></script>

  <style>
    :root {
      --bg: #0d0f12;
      --fg: #e9edf3;
      --muted: #9aa8b4;
      --accent: #7bdff6;
      --accent2: #ffa69e;
      --panel: #12161b;
      --card: #151a21;
      --ring: #232a33;
      --border: #2b3440;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height: 1.5;
    }
    .wrap {
      max-width: 1080px;
      margin: 24px auto 80px;
      padding: 0 16px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }
    h1 {
      font-size: 20px;
      margin: 0;
      letter-spacing: .4px;
      font-weight: 700;
    }
    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    button, .button {
      appearance: none;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #1a2129, #151a21);
      color: var(--fg);
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform .08s ease, border-color .2s ease, box-shadow .2s ease;
    }
    button:hover {
      transform: translateY(-1px);
      border-color: #334253;
      box-shadow: 0 8px 16px rgba(0,0,0,.25);
    }
    button:active {
      transform: translateY(0);
    }
    .grid {
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
    }
    .panel h2 {
      font-size: 14px;
      color: var(--muted);
      letter-spacing: .5px;
      font-weight: 700;
      margin: 0 0 12px;
      text-transform: uppercase;
    }
    /* Placeholder “rings” area (keep your visuals here if you have them) */
    .rings {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }
    .ring {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 12px;
      text-align: center;
      padding: 10px;
    }

    /* Final poem box */
    .poemBox {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      min-height: 160px;
      white-space: pre-wrap;
      font-size: 18px; /* adjust if you want bigger/smaller */
      line-height: 1.6;
    }
    .poemBox em { font-style: italic; }

    /* Music player */
    .music {
      display: grid;
      gap: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
    }
    .ticker {
      font-size: 13px;
      color: var(--muted);
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .sliders {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    input[type="range"] {
      accent-color: var(--accent);
    }

    /* Audio consent overlay (NOTE: starts hidden; JS will set display:flex only if needed) */
    #audio-consent {
      display: none;                /* ← keep only this one, remove any duplicate display:flex */
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.7);
      backdrop-filter: blur(2px);
      z-index: 9999;
      color: #fff;
      align-items: center;          /* these are fine even while hidden */
      justify-content: center;
      text-align: center;
      padding: 24px;
    }
    #audio-consent .card {
      background: #11161c;
      border: 1px solid #26313d;
      border-radius: 14px;
      padding: 18px 16px;
      max-width: 520px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    /* Small warning if we fall back to a tiny library */
    #libWarn {
      display: none;
      color: #ffb703;
      text-align: center;
      margin-top: 6px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Poem Rings</h1>
      <div class="controls">
        <button id="spinBtn">✨ Create Your Next Poem</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: rings + poem -->
      <div class="panel">
        <h2>Rings</h2>
        <div class="rings" id="rings">
          <div class="ring">Ring 1</div>
          <div class="ring">Ring 2</div>
          <div class="ring">Ring 3</div>
          <div class="ring">Ring 4</div>
          <div class="ring">Ring 5</div>
        </div>

        <h2 style="margin-top:16px;">Current Poem</h2>
        <div class="poemBox" id="finalPoem">
          <em>“Your poem will appear here…”</em> — by Aramish
        </div>

        <div id="libWarn">⚠️ Couldn’t load the full music library; using a tiny fallback list.</div>
      </div>

      <!-- RIGHT: music -->
      <div class="music">
        <h2>Music</h2>
        <div class="ticker" id="nowPlaying">No track yet.</div>
        <audio id="player" preload="none" controls></audio>
        <div class="sliders">
          <label>Volume <input id="volumeRange" type="range" min="0" max="1" step="0.01" value="0.7"></label>
          <label>Seek <input id="seekRange" type="range" min="0" max="100" value="0"></label>
        </div>
      </div>
    </div>
  </div>

  <!-- One-time audio consent overlay (only shown if autoplay is blocked) -->
  <div id="audio-consent">
    <div class="card">
      <h2 style="margin:0 0 6px;">Enable sound?</h2>
      <p style="margin:0 0 12px;">Tap once to allow background music. We’ll remember this for next time.</p>
      <button id="audio-consent-btn">Enable Sound</button>
    </div>
  </div>

  <script>
    /* ============ Simple poem generator placeholders ============ */
    const RINGS = [
      [
        "Strength in Silence",
        "Grace Without Seeking, Calm in a Storm",
        "The World Bends Gentler Near her Soul",
        "She is Proof That Kindness is a Force"
      ],
      [
        "Hope Carried in Quiet Hands",
        "Stillness that softens the Sharpest Edge",
        "She Listens Where Most Would Speak",
        "And Builds with the Weight of Care"
      ],
      [
        "She Moves Like Morning Light",
        "Patience Carved into the Day",
        "Every Step Writes Peace in Stone",
        "Her Silence Steadies The Storm"
      ],
      [
        "Gentle As the Breath Before Dawn",
        "Her Voice Mends What Fear Has Broken",
        "Fire Wrapped in Grace",
        "Kindness Carved into Motion"
      ],
      [
        "Dream in the Dawn",
        "Truth Without Armor, Steady in Light",
        "The Horizon Waits for Her Journey",
        "She is Proof That Fate Wears Many Faces"
      ]
    ];

    /* ====== MUSIC (library populated by index.js) ====== */
    const BAD_TRACKS = new Set();           // blacklist if a file fatally fails
    let LIBRARY = window.LIBRARY || [];
    let bag = [], bagPos = -1, currentIndex = -1;

    const player = document.getElementById('player');
    const volumeRange = document.getElementById('volumeRange');
    const seekRange = document.getElementById('seekRange');
    const ticker = document.getElementById('nowPlaying');

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function rebuildBag() {
      const idx = [];
      for (let i = 0; i < LIBRARY.length; i++) {
        if (!BAD_TRACKS.has(LIBRARY[i].name)) idx.push(i);
      }
      shuffle(idx);
      bag = idx;
      bagPos = -1;
      // console.log('[bag] rebuilt with', bag.length);
    }

    function initVolume() {
      if (!player) return;
      player.volume = Number(volumeRange?.value ?? 0.7) || 0.7;

      if (volumeRange) {
        volumeRange.addEventListener('input', () => {
          player.volume = Number(volumeRange.value);
        });
      }
      if (seekRange) {
        player.addEventListener('timeupdate', () => {
          const p = player.duration ? (player.currentTime / player.duration) * 100 : 0;
          seekRange.value = Math.floor(p);
        });
        seekRange.addEventListener('input', () => {
          if (player.duration) {
            player.currentTime = (Number(seekRange.value) / 100) * player.duration;
          }
        });
      }
    }

    function updateTicker(i) {
      const tr = LIBRARY[i];
      ticker.textContent = tr ? `Now Playing: ${tr.name}` : 'No track';
    }

    function playIndex(i, opts = {}) {
      return new Promise((resolve, reject) => {
        const tr = LIBRARY[i];
        if (!tr) return reject(new Error('No track at index ' + i));

        player.src = tr.url;
        updateTicker(i);

        const onPlay = () => {
          player.removeEventListener('playing', onPlay);
          resolve(true);
        };
        const onErr = (e) => {
          player.removeEventListener('error', onErr);
          console.warn('[audio] error on', tr.url, e);
          BAD_TRACKS.add(tr.name);
          reject(new Error('Play failed'));
        };

        player.addEventListener('playing', onPlay, { once: true });
        player.addEventListener('error', onErr, { once: true });

        const p = player.play();
        if (p && typeof p.catch === 'function') {
          p.catch(err => {
            // Autoplay likely blocked
            reject(err);
          });
        }
      });
    }

    /* ==================== AUTOPLAY consent & random start ==================== */
    async function tryStartRandomSong() {
      if (!window.LIBRARY || !window.LIBRARY.length) return false;
      if (!bag || !bag.length) rebuildBag();
      const next = (bagPos + 1) % bag.length;
      bagPos = next;
      currentIndex = bag[next];
      try {
        await playIndex(currentIndex, { loop:false, advanceBagOnSuccess:true });
        console.log('[audio] autoplay started:', LIBRARY[currentIndex]?.name);
        return true;
      } catch (e) {
        console.warn('[audio] autoplay blocked or failed:', e);
        return false;
      }
    }

    function showAudioConsentOverlay() {
      const overlay = document.getElementById('audio-consent');
      const btn = document.getElementById('audio-consent-btn');
      if (!overlay || !btn) return;

      overlay.style.display = 'flex'; // show only when needed

      const enable = async () => {
        const ok = await tryStartRandomSong();
        if (ok) {
          localStorage.setItem('poem.audioConsent', '1');
          overlay.style.display = 'none';
        } else {
          alert('Still blocked by the browser. Tap the ▶️ button once, then try again.');
        }
      };
      btn.onclick = enable;

      // Optional: clicking outside the card also enables
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) enable();
      });
    }

    async function attemptAutoplayOnOpen() {
      // If user has previously consented, autoplay will likely succeed immediately
      const ok = await tryStartRandomSong();
      if (!ok) showAudioConsentOverlay();
    }

    /* ==================== Poem logic (simple) ==================== */
    function buildRings() {
      // Keep your actual ring visuals if you have them; this is just a label filler
      const el = document.getElementById('rings');
      if (!el) return;
      [...el.children].forEach((child, i) => {
        child.textContent = `Ring ${i+1}`;
      });
    }

    function generatePoem() {
      // pick one line from each ring
      const lines = RINGS.map(group => group[Math.floor(Math.random() * group.length)]);
      // Final formatting: quoted, italic, with “— by Aramish”
      return `“${lines[0]}”\n“${lines[1]}”\n“${lines[2]}”\n“${lines[3]}”\n“${lines[4]}” — by Aramish`;
    }

    function renderPoem(initial=false) {
      const out = document.getElementById('finalPoem');
      if (!out) return;
      const text = generatePoem();
      if (initial) {
        out.textContent = text;
        return;
      }
      // simple line-by-line “magical” reveal
      out.textContent = '';
      const parts = text.split('\n');
      let i = 0;
      const tick = () => {
        if (i >= parts.length) return;
        out.textContent += (i ? '\n' : '') + parts[i++];
        setTimeout(tick, 260);
      };
      tick();
    }

    /*  ====== Build & start ========*/
    buildRings();
    renderPoem(true);
    initVolume();

    function waitForLibrary() {
      if (window.LIBRARY && window.LIBRARY.length) return Promise.resolve();
      return new Promise((resolve) => {
        let tries = 0;
        const iv = setInterval(() => {
          tries++;
          if (window.LIBRARY && window.LIBRARY.length) {
            clearInterval(iv);
            resolve();
          } else if (tries > 200) { // ~10s safety
            clearInterval(iv);
            resolve(); // proceed (will fallback if still empty)
          }
        }, 50);
        window.addEventListener('musicReady', () => {
          clearInterval(iv);
          resolve();
        }, { once: true });
      });
    }

    waitForLibrary().then(() => {
      LIBRARY = window.LIBRARY || [];
      if (!LIBRARY.length || LIBRARY.length <= 2) {
        const warn = document.getElementById('libWarn');
        if (warn) warn.style.display = 'block';
        console.warn('[music] library looks small; probably using fallback');
      } else {
        console.log('[music] library ready with', LIBRARY.length, 'tracks');
      }
      rebuildBag();
      seekRange.value = 0;

      // Try autoplay on open (shows consent sheet if blocked)
      attemptAutoplayOnOpen();
    });

    /* Spin button → new poem */
    document.getElementById('spinBtn')?.addEventListener('click', () => {
      renderPoem(false);
    });
  </script>
</body>
</html>
