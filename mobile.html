<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: #000; color: #fff; overscroll-behavior: none;
      -webkit-text-size-adjust: 100%;
    }
    /* Full-bleed wrapper that respects iOS safe areas and dynamic viewport */
    .app {
      position: fixed;
      inset: env(safe-area-inset-top,0) env(safe-area-inset-right,0)
             env(safe-area-inset-bottom,0) env(safe-area-inset-left,0);
      width: 100vw;
      height: 100dvh; /* handles mobile browser chrome changes */
      display: grid;
      place-items: center;
      background: #000; /* letterbox gutter behind the scaled app */
      overflow: hidden;
    }
    .stage {
      position: relative;
      transform-origin: top left;
      will-change: transform;
      /* optional smoothing on some browsers */
      image-rendering: -webkit-optimize-contrast;
    }
    iframe {
      display: block;
      border: 0;
      width: 100%;
      height: 100%;
      pointer-events: auto;
      background: transparent;
    }
    .hint {
      position: fixed; left: 0; right: 0; bottom: env(safe-area-inset-bottom, 0);
      text-align: center; padding: .4rem .6rem; font: 12px system-ui, -apple-system, sans-serif;
      background: rgba(0,0,0,.4); color: #ddd; opacity: 0; transition: opacity .25s ease;
      pointer-events: none; user-select: none;
    }
    .hint.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="app">
    <div id="stage" class="stage">
      <iframe id="appFrame" allow="autoplay; clipboard-read; clipboard-write"></iframe>
    </div>
  </div>
  <div id="hint" class="hint"></div>

  <script>
    // -------- CONFIG: set your desktop design size here --------
    // If your desktop layout is, e.g., 1440x900, put those numbers.
    // If you want auto-measure (less reliable), set both to 0.
    const designWidth  = 1280;
    const designHeight = 720;

    // ---------- detection ----------
    const params = new URLSearchParams(location.search);
    const forceMobile  = params.has('mobile');
    const forceDesktop = params.has('desktop');
    const ua = navigator.userAgent.toLowerCase();
    const isTouch = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;
    const isMobileUA = /iphone|ipad|ipod|android|windows phone|blackberry|silk|kindle|opera mini|mobile/.test(ua);
    const preferMobile = forceMobile || (!forceDesktop && (isMobileUA || (isTouch && innerWidth < 1024)));

    // If NOT mobile: bounce to index.html (keep query string, minus our overrides)
    if (!preferMobile) {
      const kept = [...params.entries()].filter(([k]) => k !== 'mobile' && k !== 'desktop');
      const qs = kept.length ? ('?' + new URLSearchParams(kept).toString()) : '';
      location.replace('index.html' + qs);
    }

    // ---------- elements ----------
    const stage = document.getElementById('stage');
    const iframe = document.getElementById('appFrame');
    const hint = document.getElementById('hint');

    // Forward the current query string to index.html (so app features keep working)
    iframe.src = 'index.html' + (location.search || '');

    let measured = false, autoW = 0, autoH = 0;

    function safeInset(which) {
      const v = getComputedStyle(document.documentElement).getPropertyValue(`env(safe-area-inset-${which})`);
      const px = parseFloat(v) || 0; return Number.isFinite(px) ? px : 0;
    }

    function setStageSize(w, h) {
      stage.style.width  = w + 'px';
      stage.style.height = h + 'px';
    }

    function currentDesignSize() {
      if (designWidth && designHeight) return { w: designWidth, h: designHeight };
      if (measured && autoW && autoH)  return { w: autoW, h: autoH };
      return null;
    }

    function fitScale() {
      const size = currentDesignSize();
      if (!size) return;

      const vw = window.innerWidth  - (safeInset('left') + safeInset('right'));
      const vh = window.innerHeight - (safeInset('top')  + safeInset('bottom'));

      const sw = size.w, sh = size.h;
      const scale = Math.min(vw / sw, vh / sh);

      const tx = (vw - sw * scale) / 2;
      const ty = (vh - sh * scale) / 2;

      stage.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;

      // Optional orientation nudge
      const needsLandscape = sw >= sh && vw < vh;
      hint.textContent = needsLandscape ? 'Tip: rotate your device for a better view' : '';
      hint.classList.toggle('show', !!hint.textContent);
    }

    function tryAutoMeasure() {
      try {
        const doc = iframe.contentDocument;
        if (!doc) return false;

        // Measure ONCE after app boots (fallback when designWidth/Height = 0)
        const w = Math.max(
          doc.documentElement.scrollWidth,
          doc.body?.scrollWidth || 0,
          doc.documentElement.clientWidth
        );
        const h = Math.max(
          doc.documentElement.scrollHeight,
          doc.body?.scrollHeight || 0,
          doc.documentElement.clientHeight
        );

        if (w > 0 && h > 0) {
          autoW = w; autoH = h; measured = true;
          setStageSize(autoW, autoH);
          return true;
        }
      } catch { /* cross origin or not ready yet */ }
      return false;
    }

    // Initialize
    (function init() {
      if (designWidth && designHeight) {
        setStageSize(designWidth, designHeight);
      }
      // After iframe loads, if no fixed design is provided, try auto-measure
      iframe.addEventListener('load', () => {
        if (!(designWidth && designHeight)) {
          let attempts = 0;
          const t = setInterval(() => {
            attempts++;
            const ok = tryAutoMeasure();
            fitScale();
            if (ok || attempts > 20) clearInterval(t);
          }, 150);
        } else {
          fitScale();
        }
      });

      // Refit on viewport resize/orientation (do NOT re-measure inner app)
      window.addEventListener('resize', fitScale, { passive: true });
      window.addEventListener('orientationchange', () => setTimeout(fitScale, 80), { passive: true });

      // Prevent pinch/double-tap zoom in wrapper
      document.addEventListener('gesturestart', (e) => e.preventDefault(), { passive: false });
      let lastTouch = 0;
      document.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTouch <= 300) e.preventDefault();
        lastTouch = now;
      }, { passive: false });
    })();
  </script>

  <!-- Load environment + controls exactly as before -->
  <script src="environment-loader.js" defer></script>
</body>
</html>
